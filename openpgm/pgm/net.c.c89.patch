--- net.c	2010-05-21 11:35:44.000000000 +0800
+++ net.c89	2010-08-04 15:21:42.000000000 +0800
@@ -72,19 +72,22 @@
 	pgm_assert( tolen > 0 );
 
 #ifdef NET_DEBUG
+	{
 	char saddr[INET_ADDRSTRLEN];
 	pgm_sockaddr_ntop (to, saddr, sizeof(saddr));
-	pgm_debug ("pgm_sendto (sock:%p use_rate_limit:%s use_router_alert:%s buf:%p len:%zu to:%s [toport:%d] tolen:%d)",
+	pgm_debug ("pgm_sendto (sock:%p use_rate_limit:%s use_router_alert:%s buf:%p len:%lu to:%s [toport:%d] tolen:%d)",
 		(const void*)sock,
 		use_rate_limit ? "TRUE" : "FALSE",
 		use_router_alert ? "TRUE" : "FALSE",
 		(const void*)buf,
-		len,
+		(unsigned long)len,
 		saddr,
 		ntohs (((const struct sockaddr_in*)to)->sin_port),
 		(int)tolen);
+	}
 #endif
 
+	{
 	const int send_sock = use_router_alert ? sock->send_with_router_alert_sock : sock->send_sock;
 
 	if (use_rate_limit && 
@@ -97,8 +100,9 @@
 	if (!use_router_alert && sock->can_send_data)
 		pgm_mutex_lock (&sock->send_mutex);
 
+	{
 	ssize_t sent = sendto (send_sock, buf, len, 0, to, (socklen_t)tolen);
-	pgm_debug ("sendto returned %zd", sent);
+	pgm_debug ("sendto returned %ld", (signed long)sent);
 	if (sent < 0) {
 		int save_errno = pgm_sock_errno();
 		if (PGM_UNLIKELY(errno != ENETUNREACH &&	/* Network is unreachable */
@@ -114,14 +118,14 @@
 			};
 			const int ready = poll (&p, 1, 500 /* ms */);
 #else
+			int ready;
 			fd_set writefds;
+			struct timeval tv;
 			FD_ZERO(&writefds);
 			FD_SET(send_sock, &writefds);
-			struct timeval tv = {
-				.tv_sec  = 0,
-				.tv_usec = 500 /* ms */ * 1000
-			};
-			const int ready = select (1, NULL, &writefds, NULL, &tv);
+			tv.tv_sec  = 0;
+			tv.tv_usec = 500 /* ms */ * 1000;
+			ready = select (1, NULL, &writefds, NULL, &tv);
 #endif /* CONFIG_HAVE_POLL */
 			if (ready > 0)
 			{
@@ -151,6 +155,8 @@
 	if (!use_router_alert && sock->can_send_data)
 		pgm_mutex_unlock (&sock->send_mutex);
 	return sent;
+	}
+	}
 }
 
 /* socket helper, for setting pipe ends non-blocking
